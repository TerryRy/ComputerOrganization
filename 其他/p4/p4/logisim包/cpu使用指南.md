# CPU使用指南

> 李宇衡 liyuheng55555@126.com

## 前言

这个CPU大体上和理论课讲过的单周期CPU差不多，就多一些细节，相信大家看一眼就知道怎么用，多看几眼就看明白结构了。

**注意使用新提供的2.16版logisim来打开**，据测试jdk8也是能跑的，我本地的jdk15也可以，要是jdk17 18就更没问题了。用logisim2.7可能CPU不能正常运行。

本指南请对照[视频]<https://bhpan.buaa.edu.cn:443/link/0C79FFF53E505F1C1BC20485E4FA3906>食用。

## 如何使用

使用CPU的操作可以概括为：

0. 编写汇编程序，用MARS或者自己的汇编链接器生成机器码
1. 向CPU中的指令rom加载机器码
2. 用`ctrl+k`连续运行，或者用`ctrl+t`单步运行
3. 停机后，查看内存中的运行结果

## 停机

目前CPU可能由于4种原因停机，分别为：

- 正常停机：调用`syscall`指令，不管$v0是多少。在线评测中，如果属于这种停机，才会继续判断内存内容正确性。
- 指令无法解析：可能你用了指导书之外的mips指令，或者汇编链接过程出了问题。
- ÷0：除法指令中除数为0。
- 步数超出限制：运行步数限制在4096步，你在本地可以解除这个限制。

## 主要部件

小标题与部件颜色一致。

### <font color="red">控制器</font>

负责解析指令，生成控制信号。

32位指令先被分析出指令类型，然后转化成alu选择信号、各存储元件的读写信号等。

### <font color="blue">寄存器堆</font>

内部有32个寄存器，每周期可读2个值、写1个值。

配套部件为<font color="FF5EB9">寄存器地址生成器</font>。

### <font color="orange">ALU</font>

大部分数值计算都在此进行。

### 内存

存数据的，地址位宽为10bit，数据位宽为32bit。

由于内存和指令存储器的存在，这已经是一台完整的计算机了，不过我们习惯上还是叫它CPU。

配套部件：
- <font color="6BFFEB">store处理</font>：处理字节写入与2字节写入。
- <font color="A6FFB7">load处理</font>：处理字节与2字节加载。

### 指令存储器

简言之，保存指令。

上方的是极其方便的mips反汇编探针，由华中科技大学的谭志虎老师开发，这里对他进行特别感谢~

注意，反汇编探针能解析的指令，控制器未必能解析。

## 简化区

为了同学们容易上手，在CPU主体的下方画了一个显示少量主要数据的框框。等你比较熟悉CPU结构之后，直接在上方的电路图加探针来调试会更方便。

## 调试技巧

- 这次我们用新版logisim进行实验，支持鼠标中键拖动、滚轮缩放。
- 界面中需要渲染的可变部分越少，则CPU模拟运行速度越快，程序步数很多的话建议缩放到画面中只包含四盏灯。
- 需要解析CPU结构的话，善用中键点击导线功能。
- 需要查看CPU运行到特定情况下各部件的内部情况时，右键此部件，然后`查看<部件名>`

## 最后

汇编链接实验在2022年新加了CPU运行验证这一步，CPU是前两周刚画好的，有错误的话希望指出，有问题可以通过微信或者邮箱联系我~
